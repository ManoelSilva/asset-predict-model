openapi: 3.0.0
info:
  title: B3 Model API
  description: |
    API for B3 asset prediction pipeline supporting both Random Forest and LSTM Multi-Task Learning models.
    
    **Supported Models:**
    - **Random Forest (rf)**: Traditional machine learning model for classification
    - **LSTM Multi-Task Learning (lstm)**: Deep learning model for both action prediction and return forecasting
    
    **LSTM Features:**
    - Multi-task learning with action classification and return regression
    - Configurable lookback windows for time series analysis
    - Pytorch backend for neural network training
    - Support for price prediction using return forecasts
  version: 1.0.0
servers:
  - description: Local server
    url: http://localhost:5001
  - description: EC2 server
    url: http://PUBLIC_IP:5001
paths:
  /api/b3/load-data:
    post:
      summary: Load B3 market data
      responses:
        '200':
          description: Data loaded successfully

  /api/b3/preprocess-data:
    post:
      summary: Preprocess loaded data
      responses:
        '200':
          description: Data preprocessed successfully

  /api/b3/split-data:
    post:
      summary: Split preprocessed data
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                test_size:
                  type: number
                val_size:
                  type: number
              required:
                - test_size
                - val_size
      responses:
        '200':
          description: Data split successfully

  /api/b3/train-model:
    post:
      summary: Train the model
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                n_jobs:
                  type: integer
                  description: Number of parallel jobs for training
                model_type:
                  type: string
                  enum: [ rf, random_forest, lstm, lstm_mtl ]
                  default: rf
                  description: Type of model to train (Random Forest or LSTM Multi-Task Learning)
                # LSTM-specific parameters
                lookback:
                  type: integer
                  default: 32
                  description: Number of time steps to look back for LSTM (only for LSTM models)
                horizon:
                  type: integer
                  default: 1
                  description: Prediction horizon for LSTM (only for LSTM models)
                epochs:
                  type: integer
                  default: 25
                  description: Number of training epochs for LSTM (only for LSTM models)
                batch_size:
                  type: integer
                  default: 128
                  description: Batch size for LSTM training (only for LSTM models)
                lr:
                  type: number
                  format: float
                  default: 0.001
                  description: Learning rate for LSTM training (only for LSTM models)
                units:
                  type: integer
                  default: 96
                  description: Number of LSTM units (only for LSTM models)
                dropout:
                  type: number
                  format: float
                  default: 0.2
                  description: Dropout rate for LSTM (only for LSTM models)
                price_col:
                  type: string
                  default: close
                  description: Price column name for LSTM price prediction (only for LSTM models)
              required:
                - n_jobs
      responses:
        '200':
          description: Model trained successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Model trained successfully
                  model_type:
                    type: string
                    example: RandomForestClassifier
                  best_params:
                    type: object
                    description: Best hyperparameters found during training

  /api/b3/evaluate-model:
    post:
      summary: Evaluate the trained model
      responses:
        '200':
          description: Model evaluated successfully

  /api/b3/save-model:
    post:
      summary: Save the trained model
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                model_dir:
                  type: string
                model_name:
                  type: string
              required:
                - model_dir
                - model_name
      responses:
        '200':
          description: Model saved successfully

  /api/b3/complete-pipeline:
    post:
      summary: Run the complete pipeline
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                model_dir:
                  type: string
                  description: Directory to save the trained model
                n_jobs:
                  type: integer
                  description: Number of parallel jobs for training
                test_size:
                  type: number
                  description: Proportion of data to use for testing
                val_size:
                  type: number
                  description: Proportion of data to use for validation
                model_type:
                  type: string
                  enum: [ rf, random_forest, lstm, lstm_mtl ]
                  default: rf
                  description: Type of model to train (Random Forest or LSTM Multi-Task Learning)
                # LSTM-specific parameters
                lookback:
                  type: integer
                  default: 32
                  description: Number of time steps to look back for LSTM (only for LSTM models)
                horizon:
                  type: integer
                  default: 1
                  description: Prediction horizon for LSTM (only for LSTM models)
                epochs:
                  type: integer
                  default: 25
                  description: Number of training epochs for LSTM (only for LSTM models)
                batch_size:
                  type: integer
                  default: 128
                  description: Batch size for LSTM training (only for LSTM models)
                lr:
                  type: number
                  format: float
                  default: 0.001
                  description: Learning rate for LSTM training (only for LSTM models)
                units:
                  type: integer
                  default: 96
                  description: Number of LSTM units (only for LSTM models)
                dropout:
                  type: number
                  format: float
                  default: 0.2
                  description: Dropout rate for LSTM (only for LSTM models)
                price_col:
                  type: string
                  default: close
                  description: Price column name for LSTM price prediction (only for LSTM models)
              required:
                - model_dir
                - n_jobs
                - test_size
                - val_size
      responses:
        '200':
          description: Training pipeline completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Complete training pipeline started in background
                  training_status:
                    type: string
                    example: running
                  model_type:
                    type: string
                    example: lstm

  /api/b3/pipeline-status:
    get:
      summary: Get current pipeline status
      responses:
        '200':
          description: Pipeline status returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  pipeline_state:
                    type: object
                    properties:
                      data_loaded:
                        type: boolean
                        description: Whether data has been loaded
                      data_preprocessed:
                        type: boolean
                        description: Whether data has been preprocessed
                      data_split:
                        type: boolean
                        description: Whether data has been split
                      model_trained:
                        type: boolean
                        description: Whether model has been trained
                      model_type:
                        type: string
                        description: Type of model in pipeline (rf, lstm, etc.)
                        example: lstm
                      data_shape:
                        type: array
                        items:
                          type: integer
                        description: Shape of loaded data
                        example: [ 1000, 20 ]

  /api/b3/clear-state:
    post:
      summary: Clear the pipeline state
      responses:
        '200':
          description: State cleared

  /api/b3/predict:
    post:
      summary: Make predictions using the trained pipeline for a specific ticker
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ticker:
                  type: string
                  description: Stock ticker symbol to make predictions for
                model_type:
                  type: string
                  enum: [ rf, random_forest, lstm, lstm_mtl ]
                  default: rf
                  description: Type of model to use for prediction (Random Forest or LSTM Multi-Task Learning)
              required:
                - ticker
      responses:
        '200':
          description: Prediction returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: "Predictions generated successfully for ticker: PETR4"
                  ticker:
                    type: string
                    example: PETR4
                  predictions:
                    type: array
                    items:
                      type: string
                    description: Predicted action labels (buy, sell, hold)
                    example: [ "buy" ]
                  prediction_probabilities:
                    type: array
                    items:
                      type: array
                      items:
                        type: number
                    description: Prediction probabilities for each class (only for Random Forest)
                  feature_importance:
                    type: array
                    items:
                      type: number
                    description: Feature importance scores (only for Random Forest)
                  input_shape:
                    type: array
                    items:
                      type: integer
                    description: Shape of input data used for prediction
                    example: [ 1, 15 ]
                  features_used:
                    type: array
                    items:
                      type: string
                    description: List of features used for prediction
                  model_type:
                    type: string
                    description: Actual model type used for prediction
                    example: B3KerasMTLModel
                  requested_model_type:
                    type: string
                    description: Model type requested in the API call
                    example: lstm
                  model_source:
                    type: string
                    enum: [ pipeline, storage ]
                    description: Source of the model (from pipeline state or loaded from storage)
        '400':
          description: Bad request - missing ticker or model not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: "No trained lstm model found in storage. Please train model first."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: Error making predictions
